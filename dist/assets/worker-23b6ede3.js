var it=Object.defineProperty;var rt=(f,g,d)=>g in f?it(f,g,{enumerable:!0,configurable:!0,writable:!0,value:d}):f[g]=d;var n=(f,g,d)=>(rt(f,typeof g!="symbol"?g+"":g,d),d);(function(){"use strict";var f=`#version 300 es

precision mediump float;

uniform vec2 resolution;

in  vec2 position;
in  vec2 coords;
out vec2 uv;

void main (void)
{
  gl_Position = vec4((
    position / resolution * 2.0 - 1.0
  ) * vec2(1.0, -1.0), 0.0, 1.0);

  uv = coords;
}
`,g=`#version 300 es

#ifndef GL_FRAGMENT_PRECISION_HIGH
  precision mediump float;
#else
  precision highp float;
#endif

uniform sampler2D tex;

in  vec2 uv;
out vec4 fragColor;

void main (void)
{
  fragColor = texture(tex, uv);
}
`;const d=(r,t=0,e=1)=>Math.max(t,Math.min(r,e)),x=(r,t)=>Math.random()*(t-r)+r,D=r=>r*Math.PI/180,M=(r,t=2)=>{const e=Math.pow(10,t);return~~(e*r)/e},z=({r,g:t,b:e})=>d(r*255,0,255)<<16^d(t*255,0,255)<<8^d(e*255,0,255)<<0,F=(r,t=1)=>(r=typeof r=="string"?L(r):r,{r:r>>16&t,g:r>>8&t,b:r&t}),U=(r,t)=>{const e=1/t;return r.multiply(e).sqrt,r.set(d(r.x,0,.999)*256|0,d(r.y,0,.999)*256|0,d(r.z,0,.999)*256|0)},P=r=>(r=typeof r=="number"?r:z(r),`#${`000000${r.toString(16)}`.slice(-6)}`),L=r=>(r=typeof r=="string"?r:P(r),parseInt(r.slice(1),16));class R{constructor(t,e){n(this,"context");n(this,"backEnd");n(this,"clearColor",0);n(this,"channels");n(this,"height");n(this,"width");n(this,"side");this.backEnd=e;const s=e==="2d",{canvas:i,offscreen:h}=t;this.context=i.getContext(e,this.getOptions(e,h)),this.width=i.width,this.height=i.height,this.channels=+s+3,this.side=this.width*this.channels}getOptions(t,e=!1){switch(t){case"2d":return{willReadFrequently:!e,desynchronized:e,colorSpace:"srgb",alpha:!1};case"webgpu":return{};default:return{powerPreference:"high-performance",failIfMajorPerformanceCaveat:!0,preserveDrawingBuffer:!1,premultipliedAlpha:!1,desynchronized:!0,antialias:!0,stencil:!1,depth:!1,alpha:!1}}}getPixel(t,e){return e*this.side+t*this.channels}}var B=`precision mediump float;

uniform vec2 resolution;

attribute vec2 position;
attribute vec2 coords;
varying   vec2 uv;

void main (void)
{
  gl_Position = vec4((
    position / resolution * 2.0 - 1.0
  ) * vec2(1.0, -1.0), 0.0, 1.0);

  uv = coords;
}
`,$=`#ifndef GL_FRAGMENT_PRECISION_HIGH
  precision mediump float;
#else
  precision highp float;
#endif

uniform sampler2D tex;

varying vec2 uv;

void main (void)
{
  gl_FragColor = texture2D(tex, uv);
}
`;class T extends R{constructor(e,s="webgl",i=$,h=B){super(e,s);n(this,"textureData",new Uint8ClampedArray(this.width*this.height*this.channels));n(this,"texture");n(this,"program");this.createProgram(i,h),this.createScene()}loadShader(e,s){const i=this.context.createShader(s);return this.context.shaderSource(i,e),this.context.compileShader(i),this.context.getShaderParameter(i,this.context.COMPILE_STATUS)?i:(console.error(`An error occurred compiling the shaders: ${this.context.getShaderInfoLog(i)}`),this.context.deleteShader(i))}setBufferData(e=this.width,s=this.height){this.context.bufferData(this.context.ARRAY_BUFFER,new Float32Array([0,0,e,0,0,s,0,s,e,0,e,s]),this.context.STATIC_DRAW)}createProgram(e,s){const i=this.loadShader(e,this.context.FRAGMENT_SHADER),h=this.loadShader(s,this.context.VERTEX_SHADER);if(this.program=this.context.createProgram(),h&&i&&(this.context.attachShader(this.program,i),this.context.attachShader(this.program,h),this.context.linkProgram(this.program)),!this.context.getProgramParameter(this.program,this.context.LINK_STATUS))return console.error(`Unable to initialize shader program: ${this.context.getProgramInfoLog(this.program)}`);this.context.clear(this.context.COLOR_BUFFER_BIT);const{r:o,g:c,b:l}=F(this.clearColor,1);this.context.clearColor(o,c,l,1),this.context.useProgram(this.program)}updateTexture(){this.context.activeTexture(this.context.TEXTURE0),this.context.bindTexture(this.context.TEXTURE_2D,this.texture),this.context.texImage2D(this.context.TEXTURE_2D,0,this.context.RGB,this.width,this.height,0,this.context.RGB,this.context.UNSIGNED_BYTE,this.textureData)}createScene(){const e=this.context.getAttribLocation(this.program,"coords");this.context.bindBuffer(this.context.ARRAY_BUFFER,this.context.createBuffer()),this.setBufferData(1,1),this.context.enableVertexAttribArray(e),this.context.vertexAttribPointer(e,2,this.context.FLOAT,!1,0,0);const s=this.context.getAttribLocation(this.program,"position");this.context.bindBuffer(this.context.ARRAY_BUFFER,this.context.createBuffer()),this.setBufferData(),this.context.enableVertexAttribArray(s),this.context.vertexAttribPointer(s,2,this.context.FLOAT,!1,0,0);const i=this.context.getUniformLocation(this.program,"resolution");this.context.uniform2f(i,this.width,this.height),this.texture=this.context.createTexture(),this.setBufferData(),this.updateTexture(),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_S,this.context.CLAMP_TO_EDGE),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_T,this.context.CLAMP_TO_EDGE),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MIN_FILTER,this.context.NEAREST),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MAG_FILTER,this.context.NEAREST)}drawImage(e){this.textureData=e,this.updateTexture(),this.context.drawArrays(this.context.TRIANGLES,0,6)}clear(){this.context.clear(this.context.COLOR_BUFFER_BIT)}}class q extends T{constructor(t){super(t,"webgl2",g,f)}}class V extends R{constructor(e){super(e,"2d");n(this,"image");this.context.imageSmoothingEnabled=!0,this.context.imageSmoothingQuality="high",this.image=this.context.getImageData(0,0,this.width,this.height)}drawImage(e){for(let s=0,i=0;s<e.length;s+=3,i+=4)this.image.data[i+0]=e[s+0],this.image.data[i+1]=e[s+1],this.image.data[i+2]=e[s+2],this.image.data[i+3]=255;this.context.putImageData(this.image,0,0)}clear(){this.context.fillStyle=P(this.clearColor),this.context.clearRect(0,0,this.width,this.height),this.context.fillRect(0,0,this.width,this.height)}}class a{constructor(t=0,e,s){n(this,"vec",[0,0,0]);this.vec[0]=t,this.vec[1]=e??t,this.vec[2]=s??t}multiply(t){if(typeof t!="number")return this.set(this.vec[0]*t.x,this.vec[1]*t.y,this.vec[2]*t.z);const e=t;return this.vec[0]*=e,this.vec[1]*=e,this.vec[2]*=e,this}divide(t){return typeof t=="number"?this.multiply(1/t):this.set(this.vec[0]/t.x,this.vec[1]/t.y,this.vec[2]/t.z)}get(t){return t===void 0?this.vec:this.vec[t]}refract(t,e){const s=Math.min(this.clone.negate.dot(t),1);this.copy(t.clone.multiply(s).add(this).multiply(e));const i=Math.abs(1-this.lengthSquared);return this.add(t.multiply(-Math.sqrt(i)))}set(t,e,s){return this.vec[0]=t,this.vec[1]=e,this.vec[2]=s,this}randomHemisphere(t){return this.randomUnitSphere,this.dot(t)>0?this:this.negate}random(t=0,e=1){return this.set(x(t,e),x(t,e),x(t,e))}reflect(t){return this.sub(t.clone.multiply(this.dot(t)*2))}get randomUnitVector(){return this.randomUnitSphere.unitVector}get randomUnitSphere(){for(;;)if(this.random(-1).lengthSquared<1)return this}get lengthSquared(){return this.dot(this)}get randomUnitDisk(){for(;;)if(this.random(-1),this.vec[2]=0,this.lengthSquared<1)return this}cross(t){return this.set(this.vec[1]*t.z-this.vec[2]*t.y,this.vec[2]*t.x-this.vec[0]*t.z,this.vec[0]*t.y-this.vec[1]*t.x)}dot(t){return this.vec[0]*t.x+this.vec[1]*t.y+this.vec[2]*t.z}copy(t){const{x:e,y:s,z:i}=t;return this.set(e,s,i)}add(t){return this.vec[0]+=t.x,this.vec[1]+=t.y,this.vec[2]+=t.z,this}sub(t){return this.vec[0]-=t.x,this.vec[1]-=t.y,this.vec[2]-=t.z,this}get nearZero(){return Math.abs(this.vec[0])<1e-8&&Math.abs(this.vec[1])<1e-8&&Math.abs(this.vec[2])<1e-8}get unitVector(){return this.divide(this.length)}get length(){return Math.sqrt(this.lengthSquared)}get clone(){return new a(this.vec[0],this.vec[1],this.vec[2])}reset(t=0){return this.set(t,t,t)}get print(){const[t,e,s]=this.vec;return`Vector3 { x: ${t}, y: ${e}, z: ${s} }`}get negate(){return this.vec[0]*=-1,this.vec[1]*=-1,this.vec[2]*=-1,this}get sqrt(){return this.set(Math.sqrt(this.vec[0]),Math.sqrt(this.vec[1]),Math.sqrt(this.vec[2]))}get x(){return this.vec[0]}get y(){return this.vec[1]}get z(){return this.vec[2]}}class G{constructor(){n(this,"t",0);n(this,"frontFace",!1);n(this,"material");n(this,"point",new a);n(this,"normal",new a)}copy(t){this.frontFace=t.frontFace,this.normal.copy(t.normal),this.point.copy(t.point),this.t=t.t}setFaceNormal(t,e){this.frontFace=t.direction.dot(e)<0,this.normal.copy(this.frontFace?e:e.negate)}}var v=new G;class I{}class O extends I{constructor(e){super();n(this,"objects",[]);e&&this.add(e)}add(e){this.objects.push(e)}hit(e,s,i,h){let o=!1,c=i;for(let l=0,p=this.objects.length;l<p;l++)this.objects[l].hit(e,s,c,v)&&(c=v.t,h.copy(v),o=!0);return o}clear(){this.objects.length=0}}class E{}class C extends E{constructor(e,s){super();n(this,"fuzz");n(this,"albedo");n(this,"direction",new a);this.albedo=e.clone,this.fuzz=Math.min(s,1)}scatter(e,s,i,h){const o=e.direction.unitVector.reflect(s.normal);return this.direction.randomUnitSphere.multiply(this.fuzz).add(o),i.direction=this.direction,i.origin=s.point,h.copy(this.albedo),this.direction.dot(s.normal)>0}}class y extends E{constructor(e){super();n(this,"albedo");n(this,"direction",new a);this.albedo=e.clone}scatter(e,s,i,h){const o=s.normal.add(this.direction.randomUnitVector);return o.nearZero&&o.copy(s.normal),i.direction=o,i.origin=s.point,h.copy(this.albedo),!0}}class A extends E{constructor(t){super(),this.refraction=t}reflectance(t,e){const s=Math.pow((1-e)/(1+e),2);return Math.pow(1-t,5)*(1-s)+s}scatter(t,e,s,i){const h=t.direction.unitVector,o=Math.min(h.clone.negate.dot(e.normal),1),c=e.frontFace?1/this.refraction:this.refraction;return Math.sqrt(1-o*o)*c>1||Math.random()<this.reflectance(o,c)?h.reflect(e.normal):h.refract(e.normal,c),s.direction=h,s.origin=e.point,i.reset(1),!0}}class N{constructor(){n(this,"hittables",new O);n(this,"color",new a);this.addSphere(new a(0,-1e3,0),1e3,new y(new a(.5))),this.generateSmallSpheres(),this.addSphere(new a(0,1,0),1,new A(1.5)),this.addSphere(new a(-4,1,0),1,new y(new a(.4,.2,.1))),this.addSphere(new a(4,1,0),1,new C(new a(.7,.6,.5),0))}addSphere(t,e,s){this.hittables.add(new W(t,e,s))}generateSmallSpheres(){for(let t=-11;t<11;t++)for(let e=-11;e<11;e++){const s=new a(Math.random()*.9+t,.2,Math.random()*.9+e),i=new a(4,.2,0);if(s.clone.sub(i).length>.9){const h=Math.random();if(h<.8){this.color.random().multiply(this.color.random());const o=new y(this.color);this.addSphere(s,.2,o)}else if(h<.95){this.color.random(.5);const o=x(0,.5),c=new C(this.color,o);this.addSphere(s,.2,c)}else{const o=new A(1.5);this.addSphere(s,.2,o)}}}}get objects(){return this.hittables}}class W extends I{constructor(t,e,s){super(),this.center=t,this.radius=e,this.material=s}hit(t,e,s,i){const h=t.origin.clone.sub(this.center),o=t.direction.lengthSquared,c=h.dot(t.direction),l=h.lengthSquared-this.radius*this.radius,p=c*c-o*l;if(p<0)return!1;const w=Math.sqrt(p);let m=(-c-w)/o;if((m<e||m>s)&&(m=(-c+w)/o,m<e||m>s))return!1;i.t=m,i.point.copy(t.at(i.t));const b=i.point.clone.sub(this.center).divide(this.radius);return i.setFaceNormal(t,b),i.material=this.material,!0}}var u;(r=>{r.Scene={pixelRatio:1,maxDepth:50,samples:500,backEnd:"2d",height:400,width:600}})(u||(u={}));class X{constructor(){n(this,"width",u.Scene.width);n(this,"height",u.Scene.height);n(this,"ratio",this.width/this.height);n(this,"callbacks",[])}addResizeCallback(t){this.callbacks.indexOf(t)===-1&&this.callbacks.push(t)}removeResizeCallback(t){const e=this.callbacks.indexOf(t);e!==-1&&this.callbacks.splice(e,1)}update(t=u.Scene.width,e=u.Scene.height){this.width=t,this.height=e,this.ratio=this.width/this.height;for(let s=this.callbacks.length;s--;)this.callbacks[s](this.width,this.height,this.ratio)}dispose(){this.callbacks.length=0}get size(){return{height:this.height,width:this.width,ratio:this.ratio}}}var H=new X;class j{constructor(t,e,s,i,h,o,c){n(this,"u");n(this,"v");n(this,"width");n(this,"height");n(this,"origin");n(this,"vertical");n(this,"lensRadius");n(this,"horizontal");n(this,"random",new a);n(this,"lowerLeftCorner");const l=t.clone.sub(e).unitVector,p=Math.tan(D(i)*.5);this.u=s.cross(l).unitVector,this.v=l.clone.cross(this.u),this.origin=t,this.height=p*2,this.width=h*this.height,this.lensRadius=o*.5,this.horizontal=this.u.clone.multiply(this.width).multiply(c),this.vertical=this.v.clone.multiply(this.height).multiply(c),this.lowerLeftCorner=this.origin.clone.sub(this.horizontal.clone.divide(2)).sub(this.vertical.clone.divide(2)).sub(l.multiply(c))}setRay(t,e,s){const i=this.random.randomUnitDisk.multiply(this.lensRadius),h=this.u.clone.multiply(i.x).add(this.v.clone.multiply(i.y));return t.direction=this.lowerLeftCorner.clone.add(this.horizontal.clone.multiply(e)).add(this.vertical.clone.multiply(s)).sub(this.origin).sub(h),t.origin=h.add(this.origin),t}}class S{constructor(t=new a,e=new a){n(this,"color",new a(1));n(this,"far",1/0);n(this,"near",.001);this.orig=t,this.dir=e}at(t){return this.orig.clone.add(this.dir.clone.multiply(t))}getColor(t,e,s){if(!s)return this.color.reset();if(e.hit(t,this.near,this.far,v)){const h=new a,o=new S;return v.material.scatter(t,v,o,h)?this.getColor(o,e,s-1).multiply(h):this.color.reset()}const i=(t.dir.unitVector.y+1)*.5;return this.color.reset(1).multiply(1-i).add(new a(.5,.7,1).multiply(i))}set direction(t){this.dir.copy(t)}get direction(){return this.dir}set origin(t){this.orig.copy(t)}get origin(){return this.orig}}class k{constructor(){n(this,"camera");n(this,"world",new N);n(this,"color",new a);n(this,"width",u.Scene.width);n(this,"height",u.Scene.height);n(this,"depth",u.Scene.maxDepth);n(this,"samples",u.Scene.samples);this.camera=new j(new a(13,2,3),new a(0,0,0),new a(0,1,0),20,H.size.ratio,.1,10)}createPPMImage(){const t=new Uint8ClampedArray(this.width*this.height*3),e=Date.now(),s=new S;for(let i=0,h=this.height-1,o=this.width-1,c=h;h>-1;h--){console.info(`Progress: ${M((1-h/c)*100)}%`);for(let l=0;l<this.width;l++,i+=3){this.color.reset();for(let b=0;b<this.samples;b++){const et=(l+Math.random())/o,st=(h+Math.random())/c;this.camera.setRay(s,et,st),this.color.add(s.getColor(s,this.world.objects,this.depth))}const{x:p,y:w,z:m}=U(this.color,this.samples);t[i+0]=p,t[i+1]=w,t[i+2]=m}}return console.info(`Time: ${M((Date.now()-e)/1e3)} sec.`),t}}class Y extends CustomEvent{constructor(){super(...arguments);n(this,"data")}}class Z{constructor(){n(this,"target",new EventTarget);n(this,"events",new Map);n(this,"callbacks",new Map)}add(t,e){const s=this.callbacks.get(t);s?s.push(e):this.callbacks.set(t,[e]),this.events.set(t,new Y(t)),this.target.addEventListener(t,e,!1)}dispatch(t,e){const s=this.events.get(t);s&&(s.data=e,this.target.dispatchEvent(s))}remove(t,e){const s=this.callbacks.get(t);if(s&&e){const i=s.indexOf(e),h=e;i!==-1&&s.splice(i,1),this.target.removeEventListener(t,h,!1)}e||(s==null||s.forEach(i=>this.target.removeEventListener(t,i,!1)),this.callbacks.delete(t),this.events.delete(t))}dispose(){this.callbacks.clear(),this.events.clear()}}class _{constructor(t){this.worker=t}add(t,e){this.worker.add(t,e)}static dispatch(t,e){tt.postMessage({name:t,response:{data:e}})}remove(t){this.worker.remove(t)}dispose(){this.worker.dispose()}}class K extends Z{constructor(){super(...arguments);n(this,"offscreen",!1);n(this,"workerEvents")}createWorkerEvents(e,s){this.workerEvents=new _(e),this.offscreen=s}add(e,s){var i;this.offscreen?(i=this.workerEvents)==null||i.add(e,s):super.add(e,s)}dispatch(e,s,i=!1){i?_.dispatch(e,s):super.dispatch(e,s)}remove(e,s){var i;this.offscreen?(i=this.workerEvents)==null||i.remove(e):super.remove(e,s)}dispose(){var e;(e=this.workerEvents)==null||e.dispose(),super.dispose()}}var Q=new K;class J{constructor(t){n(this,"canvas");n(this,"tracer");n(this,"worker");this.canvas=this.createCanvas(t),(this.worker=t.worker)?this.createWorkerEvents():this.tracer=new k,this.canvas.clear(),this.createPPMImage()}createCanvas(t){switch(t.backEnd){case"webgl2":return new q(t);case"webgl":return new T(t);default:return new V(t)}}createWorkerEvents(){var t;(t=this.worker)==null||t.add("Create::PPMImage",this.showPPMImage.bind(this))}createPPMImage(t=!1){var e;this.worker?this.worker.post("Create::PPMImage",{download:t}):this.showPPMImage({download:t,pixels:(e=this.tracer)==null?void 0:e.createPPMImage()},!0)}showPPMImage(t,e){const{download:s,pixels:i}=t;s&&this.downloadPPMImage(i,e),this.canvas.drawImage(i)}downloadPPMImage(t,e){let s=`P3
${this.canvas.width} ${this.canvas.height}
255
`;for(let i=0;i<t.length;i+=3)s+=`${t[i]} ${t[i+1]} ${t[i+2]}
`;Q.dispatch("Download::PPMImage",{image:s},e)}}self.onerror=r=>console.error(r),self.onmessage=r=>{const{event:t}=r.data;let{params:e}=r.data;const s=new k;switch(t){case"Transfer::Offscreen":return new J({offscreen:!0,...e});case"Create::PPMImage":{const i=s.createPPMImage();e={...e,pixels:i};break}}self.postMessage({response:e,name:t})};var tt=self})();
