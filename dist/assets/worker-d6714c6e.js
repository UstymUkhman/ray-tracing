var pt=Object.defineProperty;var mt=(f,p,u)=>p in f?pt(f,p,{enumerable:!0,configurable:!0,writable:!0,value:u}):f[p]=u;var r=(f,p,u)=>(mt(f,typeof p!="symbol"?p+"":p,u),u);(function(){"use strict";var f=`#version 300 es

precision mediump float;

uniform vec2 resolution;

in  vec2 position;
in  vec2 coords;
out vec2 uv;

void main (void)
{
  gl_Position = vec4((
    position / resolution * 2.0 - 1.0
  ) * vec2(1.0, -1.0), 0.0, 1.0);

  uv = coords;
}
`,p=`#version 300 es

#ifndef GL_FRAGMENT_PRECISION_HIGH
  precision mediump float;
#else
  precision highp float;
#endif

uniform sampler2D tex;

in  vec2 uv;
out vec4 fragColor;

void main (void)
{
  fragColor = texture(tex, uv);
}
`;const u=(n,t=0,e=1)=>Math.max(t,Math.min(n,e)),x=(n,t)=>Math.random()*(t-n)+n,$=n=>n*Math.PI/180,b=(n,t=2)=>{const e=Math.pow(10,t);return~~(e*n)/e},B=16.666666666666668,q=({r:n,g:t,b:e})=>u(n*255,0,255)<<16^u(t*255,0,255)<<8^u(e*255,0,255)<<0,V=(n,t=1)=>(n=typeof n=="string"?O(n):n,{r:n>>16&t,g:n>>8&t,b:n&t}),G=(n,t)=>{const e=1/t;return n.multiply(e).sqrt,n.set(u(n.x,0,.999)*256|0,u(n.y,0,.999)*256|0,u(n.z,0,.999)*256|0)},M=n=>(n=typeof n=="number"?n:q(n),`#${`000000${n.toString(16)}`.slice(-6)}`),O=n=>(n=typeof n=="string"?n:M(n),parseInt(n.slice(1),16));class R{constructor(t,e){r(this,"context");r(this,"backEnd");r(this,"clearColor",0);r(this,"channels");r(this,"height");r(this,"width");r(this,"side");this.backEnd=e;const s=e==="2d",{canvas:i,offscreen:h}=t;this.context=i.getContext(e,this.getOptions(e,h)),this.width=i.width,this.height=i.height,this.channels=+s+3,this.side=this.width*this.channels}getOptions(t,e=!1){switch(t){case"2d":return{willReadFrequently:!e,desynchronized:e,colorSpace:"srgb",alpha:!1};case"webgpu":return{};default:return{powerPreference:"high-performance",failIfMajorPerformanceCaveat:!0,preserveDrawingBuffer:!1,premultipliedAlpha:!1,desynchronized:!0,antialias:!0,stencil:!1,depth:!1,alpha:!1}}}getPixel(t,e){return e*this.side+t*this.channels}}var N=`precision mediump float;

uniform vec2 resolution;

attribute vec2 position;
attribute vec2 coords;
varying   vec2 uv;

void main (void)
{
  gl_Position = vec4((
    position / resolution * 2.0 - 1.0
  ) * vec2(1.0, -1.0), 0.0, 1.0);

  uv = coords;
}
`,W=`#ifndef GL_FRAGMENT_PRECISION_HIGH
  precision mediump float;
#else
  precision highp float;
#endif

uniform sampler2D tex;

varying vec2 uv;

void main (void)
{
  gl_FragColor = texture2D(tex, uv);
}
`;class I extends R{constructor(e,s="webgl",i=W,h=N){super(e,s);r(this,"textureData",new Uint8ClampedArray(this.width*this.height*this.channels));r(this,"texture");r(this,"program");this.createProgram(i,h),this.createScene()}loadShader(e,s){const i=this.context.createShader(s);return this.context.shaderSource(i,e),this.context.compileShader(i),this.context.getShaderParameter(i,this.context.COMPILE_STATUS)?i:(console.error(`An error occurred compiling the shaders: ${this.context.getShaderInfoLog(i)}`),this.context.deleteShader(i))}setBufferData(e=this.width,s=this.height){this.context.bufferData(this.context.ARRAY_BUFFER,new Float32Array([0,0,e,0,0,s,0,s,e,0,e,s]),this.context.STATIC_DRAW)}createProgram(e,s){const i=this.loadShader(e,this.context.FRAGMENT_SHADER),h=this.loadShader(s,this.context.VERTEX_SHADER);if(this.program=this.context.createProgram(),h&&i&&(this.context.attachShader(this.program,i),this.context.attachShader(this.program,h),this.context.linkProgram(this.program)),!this.context.getProgramParameter(this.program,this.context.LINK_STATUS))return console.error(`Unable to initialize shader program: ${this.context.getProgramInfoLog(this.program)}`);this.context.clear(this.context.COLOR_BUFFER_BIT);const{r:o,g:c,b:l}=V(this.clearColor,1);this.context.clearColor(o,c,l,1),this.context.useProgram(this.program)}updateTexture(){this.context.activeTexture(this.context.TEXTURE0),this.context.bindTexture(this.context.TEXTURE_2D,this.texture),this.context.texImage2D(this.context.TEXTURE_2D,0,this.context.RGB,this.width,this.height,0,this.context.RGB,this.context.UNSIGNED_BYTE,this.textureData)}createScene(){const e=this.context.getAttribLocation(this.program,"coords");this.context.bindBuffer(this.context.ARRAY_BUFFER,this.context.createBuffer()),this.setBufferData(1,1),this.context.enableVertexAttribArray(e),this.context.vertexAttribPointer(e,2,this.context.FLOAT,!1,0,0);const s=this.context.getAttribLocation(this.program,"position");this.context.bindBuffer(this.context.ARRAY_BUFFER,this.context.createBuffer()),this.setBufferData(),this.context.enableVertexAttribArray(s),this.context.vertexAttribPointer(s,2,this.context.FLOAT,!1,0,0);const i=this.context.getUniformLocation(this.program,"resolution");this.context.uniform2f(i,this.width,this.height),this.texture=this.context.createTexture(),this.setBufferData(),this.updateTexture(),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_S,this.context.CLAMP_TO_EDGE),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_T,this.context.CLAMP_TO_EDGE),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MIN_FILTER,this.context.NEAREST),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MAG_FILTER,this.context.NEAREST)}drawImage(e){this.textureData=e,this.updateTexture(),this.context.drawArrays(this.context.TRIANGLES,0,6)}clear(){this.context.clear(this.context.COLOR_BUFFER_BIT)}}class X extends I{constructor(t){super(t,"webgl2",p,f)}}class H extends R{constructor(e){super(e,"2d");r(this,"image");this.context.imageSmoothingEnabled=!0,this.context.imageSmoothingQuality="high",this.image=this.context.getImageData(0,0,this.width,this.height)}drawImage(e){for(let s=0,i=0;s<e.length;s+=3,i+=4)this.image.data[i+0]=e[s+0],this.image.data[i+1]=e[s+1],this.image.data[i+2]=e[s+2],this.image.data[i+3]=255;this.context.putImageData(this.image,0,0)}clear(){this.context.fillStyle=M(this.clearColor),this.context.clearRect(0,0,this.width,this.height),this.context.fillRect(0,0,this.width,this.height)}}var d={backEnd:"webgl2",pixelRatio:1,maxDepth:50,samples:500,height:240,width:360};class a{constructor(t=0,e,s){r(this,"vec",[0,0,0]);this.vec[0]=t,this.vec[1]=e??t,this.vec[2]=s??t}multiply(t){if(typeof t!="number")return this.set(this.vec[0]*t.x,this.vec[1]*t.y,this.vec[2]*t.z);const e=t;return this.vec[0]*=e,this.vec[1]*=e,this.vec[2]*=e,this}divide(t){return typeof t=="number"?this.multiply(1/t):this.set(this.vec[0]/t.x,this.vec[1]/t.y,this.vec[2]/t.z)}get(t){return t===void 0?this.vec:this.vec[t]}refract(t,e){const s=Math.min(this.clone.negate.dot(t),1);this.copy(t.clone.multiply(s).add(this).multiply(e));const i=Math.abs(1-this.lengthSquared);return this.add(t.multiply(-Math.sqrt(i)))}set(t,e,s){return this.vec[0]=t,this.vec[1]=e,this.vec[2]=s,this}randomHemisphere(t){return this.randomUnitSphere,this.dot(t)>0?this:this.negate}random(t=0,e=1){return this.set(x(t,e),x(t,e),x(t,e))}reflect(t){return this.sub(t.clone.multiply(this.dot(t)*2))}get randomUnitVector(){return this.randomUnitSphere.unitVector}get randomUnitSphere(){for(;;)if(this.random(-1).lengthSquared<1)return this}get lengthSquared(){return this.dot(this)}get randomUnitDisk(){for(;;)if(this.random(-1),this.vec[2]=0,this.lengthSquared<1)return this}cross(t){return this.set(this.vec[1]*t.z-this.vec[2]*t.y,this.vec[2]*t.x-this.vec[0]*t.z,this.vec[0]*t.y-this.vec[1]*t.x)}dot(t){return this.vec[0]*t.x+this.vec[1]*t.y+this.vec[2]*t.z}copy(t){const{x:e,y:s,z:i}=t;return this.set(e,s,i)}add(t){return this.vec[0]+=t.x,this.vec[1]+=t.y,this.vec[2]+=t.z,this}sub(t){return this.vec[0]-=t.x,this.vec[1]-=t.y,this.vec[2]-=t.z,this}get nearZero(){return Math.abs(this.vec[0])<1e-8&&Math.abs(this.vec[1])<1e-8&&Math.abs(this.vec[2])<1e-8}get unitVector(){return this.divide(this.length)}get length(){return Math.sqrt(this.lengthSquared)}get clone(){return new a(this.vec[0],this.vec[1],this.vec[2])}reset(t=0){return this.set(t,t,t)}get print(){const[t,e,s]=this.vec;return`Vector3 { x: ${t}, y: ${e}, z: ${s} }`}get negate(){return this.vec[0]*=-1,this.vec[1]*=-1,this.vec[2]*=-1,this}get sqrt(){return this.set(Math.sqrt(this.vec[0]),Math.sqrt(this.vec[1]),Math.sqrt(this.vec[2]))}get x(){return this.vec[0]}get y(){return this.vec[1]}get z(){return this.vec[2]}}class j{constructor(){r(this,"t",0);r(this,"frontFace",!1);r(this,"material");r(this,"point",new a);r(this,"normal",new a)}copy(t){this.frontFace=t.frontFace,this.normal.copy(t.normal),this.point.copy(t.point),this.t=t.t}setFaceNormal(t,e){this.frontFace=t.direction.dot(e)<0,this.normal.copy(this.frontFace?e:e.negate)}}var w=new j;class A{}class Y extends A{constructor(e){super();r(this,"objects",[]);e&&this.add(e)}add(e){this.objects.push(e)}hit(e,s,i,h){let o=!1,c=i;for(let l=0,m=this.objects.length;l<m;l++)this.objects[l].hit(e,s,c,w)&&(c=w.t,h.copy(w),o=!0);return o}clear(){this.objects.length=0}}class E{}class D extends E{constructor(e,s){super();r(this,"fuzz");r(this,"albedo");r(this,"direction",new a);this.albedo=e.clone,this.fuzz=Math.min(s,1)}scatter(e,s,i,h){const o=e.direction.unitVector.reflect(s.normal);return this.direction.randomUnitSphere.multiply(this.fuzz).add(o),i.direction=this.direction,i.origin=s.point,h.copy(this.albedo),this.direction.dot(s.normal)>0}}class y extends E{constructor(e){super();r(this,"albedo");r(this,"direction",new a);this.albedo=e.clone}scatter(e,s,i,h){const o=s.normal.add(this.direction.randomUnitVector);return o.nearZero&&o.copy(s.normal),i.direction=o,i.origin=s.point,h.copy(this.albedo),!0}}class C extends E{constructor(t){super(),this.refraction=t}reflectance(t,e){const s=Math.pow((1-e)/(1+e),2);return Math.pow(1-t,5)*(1-s)+s}scatter(t,e,s,i){const h=t.direction.unitVector,o=Math.min(h.clone.negate.dot(e.normal),1),c=e.frontFace?1/this.refraction:this.refraction;return Math.sqrt(1-o*o)*c>1||Math.random()<this.reflectance(o,c)?h.reflect(e.normal):h.refract(e.normal,c),s.direction=h,s.origin=e.point,i.reset(1),!0}}class Z{constructor(){r(this,"hittables",new Y);r(this,"color",new a);this.addSphere(new a(0,-1e3,0),1e3,new y(new a(.5))),this.generateSmallSpheres(),this.addSphere(new a(0,1,0),1,new C(1.5)),this.addSphere(new a(-4,1,0),1,new y(new a(.4,.2,.1))),this.addSphere(new a(4,1,0),1,new D(new a(.7,.6,.5),0))}addSphere(t,e,s){this.hittables.add(new K(t,e,s))}generateSmallSpheres(){for(let t=-11;t<11;t++)for(let e=-11;e<11;e++){const s=new a(Math.random()*.9+t,.2,Math.random()*.9+e),i=new a(4,.2,0);if(s.clone.sub(i).length>.9){const h=Math.random();if(h<.8){this.color.random().multiply(this.color.random());const o=new y(this.color);this.addSphere(s,.2,o)}else if(h<.95){this.color.random(.5);const o=x(0,.5),c=new D(this.color,o);this.addSphere(s,.2,c)}else{const o=new C(1.5);this.addSphere(s,.2,o)}}}}get objects(){return this.hittables}}class K extends A{constructor(t,e,s){super(),this.center=t,this.radius=e,this.material=s}hit(t,e,s,i){const h=t.origin.clone.sub(this.center),o=t.direction.lengthSquared,c=h.dot(t.direction),l=h.lengthSquared-this.radius*this.radius,m=c*c-o*l;if(m<0)return!1;const v=Math.sqrt(m);let g=(-c-v)/o;if((g<e||g>s)&&(g=(-c+v)/o,g<e||g>s))return!1;i.t=g,i.point.copy(t.at(i.t));const T=i.point.clone.sub(this.center).divide(this.radius);return i.setFaceNormal(t,T),i.material=this.material,!0}}class Q{constructor(){r(this,"width",d.width);r(this,"height",d.height);r(this,"ratio",this.width/this.height);r(this,"callbacks",[])}addResizeCallback(t){this.callbacks.indexOf(t)===-1&&this.callbacks.push(t)}removeResizeCallback(t){const e=this.callbacks.indexOf(t);e!==-1&&this.callbacks.splice(e,1)}update(t=d.width,e=d.height){this.width=t,this.height=e,this.ratio=this.width/this.height;for(let s=this.callbacks.length;s--;)this.callbacks[s](this.width,this.height,this.ratio)}dispose(){this.callbacks.length=0}get size(){return{height:this.height,width:this.width,ratio:this.ratio}}}var J=new Q;class tt{constructor(t,e,s,i,h,o,c){r(this,"u");r(this,"v");r(this,"width");r(this,"height");r(this,"origin");r(this,"vertical");r(this,"lensRadius");r(this,"horizontal");r(this,"random",new a);r(this,"lowerLeftCorner");const l=t.clone.sub(e).unitVector,m=Math.tan($(i)*.5);this.u=s.cross(l).unitVector,this.v=l.clone.cross(this.u),this.origin=t,this.height=m*2,this.width=h*this.height,this.lensRadius=o*.5,this.horizontal=this.u.clone.multiply(this.width).multiply(c),this.vertical=this.v.clone.multiply(this.height).multiply(c),this.lowerLeftCorner=this.origin.clone.sub(this.horizontal.clone.divide(2)).sub(this.vertical.clone.divide(2)).sub(l.multiply(c))}setRay(t,e,s){const i=this.random.randomUnitDisk.multiply(this.lensRadius),h=this.u.clone.multiply(i.x).add(this.v.clone.multiply(i.y));t.direction=this.lowerLeftCorner.clone.add(this.horizontal.clone.multiply(e)).add(this.vertical.clone.multiply(s)).sub(this.origin).sub(h),t.origin=h.add(this.origin)}}class S{constructor(t=new a,e=new a){r(this,"color",new a(1));r(this,"far",1/0);r(this,"near",.001);this.orig=t,this.dir=e}at(t){return this.orig.clone.add(this.dir.clone.multiply(t))}getColor(t,e,s){if(!s)return this.color.reset();if(e.hit(t,this.near,this.far,w)){const h=new a,o=new S;return w.material.scatter(t,w,o,h)?this.getColor(o,e,s-1).multiply(h):this.color.reset()}const i=(t.dir.unitVector.y+1)*.5;return this.color.reset(1).multiply(1-i).add(new a(.5,.7,1).multiply(i))}set direction(t){this.dir.copy(t)}get direction(){return this.dir}set origin(t){this.orig.copy(t)}get origin(){return this.orig}}class k{constructor(){r(this,"last",Date.now());r(this,"camera");r(this,"world",new Z);r(this,"color",new a);r(this,"width",d.width);r(this,"height",d.height);r(this,"depth",d.maxDepth);r(this,"samples",d.samples);this.camera=new tt(new a(13,2,3),new a(0,0,0),new a(0,1,0),20,J.size.ratio,.1,10)}createPPMImage(t,e,s=this.samples){const i=new S,h=this.samples===s;for(let v=0,g=this.height-1,T=this.width-1,F=g;g>-1;g--){h&&console.info(`Progress: ${b((1-g/F)*100)}%`);for(let P=0;P<this.width;P++,v+=3){this.color.reset();for(let L=0;L<s;L++){const ut=(P+Math.random())/T,gt=(g+Math.random())/F;this.camera.setRay(i,ut,gt),this.color.add(i.getColor(i,this.world.objects,this.depth))}const{x:ct,y:lt,z:dt}=G(this.color,s);t[v+0]=ct,t[v+1]=lt,t[v+2]=dt}}const o=Date.now(),c=`${h&&"Total "||""}Samples: ${s}`,l=`Total Time: ${b((o-e)/1e3)} sec.`,m=`Last Render Time: ${b((o-this.last)/1e3)} sec.`;console.info(`${c} | ${m} | ${l}`),this.last=o}}class et extends CustomEvent{constructor(){super(...arguments);r(this,"data")}}class st{constructor(){r(this,"target",new EventTarget);r(this,"events",new Map);r(this,"callbacks",new Map)}add(t,e){const s=this.callbacks.get(t);s?s.push(e):this.callbacks.set(t,[e]),this.events.set(t,new et(t)),this.target.addEventListener(t,e,!1)}dispatch(t,e){const s=this.events.get(t);s&&(s.data=e,this.target.dispatchEvent(s))}remove(t,e){const s=this.callbacks.get(t);if(s&&e){const i=s.indexOf(e),h=e;i!==-1&&s.splice(i,1),this.target.removeEventListener(t,h,!1)}e||(s==null||s.forEach(i=>this.target.removeEventListener(t,i,!1)),this.callbacks.delete(t),this.events.delete(t))}dispose(){this.callbacks.clear(),this.events.clear()}}class _{constructor(t){this.worker=t}add(t,e){this.worker.add(t,e)}static dispatch(t,e){at.postMessage({name:t,response:{data:e}})}remove(t){this.worker.remove(t)}dispose(){this.worker.dispose()}}class it extends st{constructor(){super(...arguments);r(this,"offscreen",!1);r(this,"workerEvents")}createWorkerEvents(e,s){this.workerEvents=new _(e),this.offscreen=s}add(e,s){var i;this.offscreen?(i=this.workerEvents)==null||i.add(e,s):super.add(e,s)}dispatch(e,s,i=!1){i?_.dispatch(e,s):super.dispatch(e,s)}remove(e,s){var i;this.offscreen?(i=this.workerEvents)==null||i.remove(e):super.remove(e,s)}dispose(){var e;(e=this.workerEvents)==null||e.dispose(),super.dispose()}}var rt=new it;class nt{constructor(t){r(this,"nextSample",0);r(this,"canvas");r(this,"tracer");r(this,"worker");r(this,"start",Date.now());r(this,"samples",d.samples);r(this,"pixels",new Uint8ClampedArray(d.width*d.height*3));this.canvas=this.createCanvas(t),(this.worker=t.worker)?this.createWorkerEvents():this.tracer=new k,this.canvas.clear(),this.createPPMImage()}createCanvas(t){switch(t.backEnd){case"webgl2":return new X(t);case"webgl":return new I(t);default:return new H(t)}}createWorkerEvents(){var t;(t=this.worker)==null||t.add("Create::PPMImage",this.showPPMImage.bind(this))}createPPMImage(t=!1){var e;if(this.worker)return this.worker.post("Create::PPMImage",{download:t});(e=this.tracer)==null||e.createPPMImage(this.pixels,this.start,++this.nextSample),this.showPPMImage({pixels:this.pixels,sample:this.nextSample,download:t},!0)}showPPMImage(t,e){const s=t;this.canvas.drawImage(s.pixels),this.samples===s.sample||!(this.worker?s.sample:this.nextSample)?s.download&&this.downloadPPMImage(s.pixels,e):setTimeout(this.createPPMImage.bind(this,s.download),B)}downloadPPMImage(t,e){let s=`P3
${this.canvas.width} ${this.canvas.height}
255
`;for(let i=0;i<t.length;i+=3)s+=`${t[i]} ${t[i+1]} ${t[i+2]}
`;rt.dispatch("Download::PPMImage",{image:s},e)}}let ht=0,U=0;const ot=new k,z=new Uint8ClampedArray(d.width*d.height*3);self.onerror=n=>console.error(n),self.onmessage=n=>{const{event:t}=n.data;let{params:e}=n.data;switch(t){case"Transfer::Offscreen":return new nt({offscreen:!0,...e});case"Create::PPMImage":{ot.createPPMImage(z,ht||(ht=Date.now()),++U),e={sample:U,pixels:z,...e};break}}self.postMessage({response:e,name:t})};var at=self})();
